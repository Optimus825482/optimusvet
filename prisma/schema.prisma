generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

model User {
  id            String        @id @default(cuid())
  name          String?
  email         String        @unique
  emailVerified DateTime?
  password      String?
  image         String?
  role          UserRole      @default(USER)
  active        Boolean       @default(true)
  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt
  accounts      Account[]
  reminders     Reminder[]
  sessions      Session[]
  transactions  Transaction[]
  collections   Collection[]

  @@map("users")
}

model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String?
  access_token      String?
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String?
  session_state     String?
  user              User    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
  @@map("accounts")
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("sessions")
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
  @@map("verification_tokens")
}

model Customer {
  id           String        @id @default(cuid())
  code         String        @unique
  musId        Int?          @unique
  name         String
  phone        String?
  email        String?
  address      String?
  city         String?
  district     String?
  taxNumber    String?
  taxOffice    String?
  image        String?
  notes        String?
  balance      Decimal       @default(0) @db.Decimal(12, 2)
  isActive     Boolean       @default(true)
  createdAt    DateTime      @default(now())
  updatedAt    DateTime      @updatedAt
  animals      Animal[]
  reminders    Reminder[]
  transactions Transaction[]
  collections  Collection[]

  @@map("customers")
}

model Supplier {
  id           String        @id @default(cuid())
  code         String        @unique
  name         String
  phone        String?
  email        String?
  address      String?
  taxNumber    String?
  taxOffice    String?
  contactName  String?
  image        String?
  notes        String?
  balance      Decimal       @default(0) @db.Decimal(12, 2)
  isActive     Boolean       @default(true)
  createdAt    DateTime      @default(now())
  updatedAt    DateTime      @updatedAt
  city         String?
  district     String?
  reminders    Reminder[]
  transactions Transaction[]

  @@map("suppliers")
}

model Category {
  id        String    @id @default(cuid())
  name      String    @unique
  color     String?
  createdAt DateTime  @default(now())
  products  Product[]

  @@map("product_categories")
}

model Product {
  id               String            @id @default(cuid())
  code             String            @unique
  name             String
  barcode          String?
  categoryId       String?
  productCategory  ProductCategory   @default(MEDICINE)
  unit             String            @default("Adet")
  purchasePrice    Decimal           @default(0) @db.Decimal(12, 2)
  salePrice        Decimal           @default(0) @db.Decimal(12, 2)
  vatRate          Decimal           @default(0) @db.Decimal(5, 2)
  stock            Decimal           @default(0) @db.Decimal(12, 3)
  criticalLevel    Decimal           @default(0) @db.Decimal(12, 3)
  expiryDate       DateTime?
  lotNumber        String?
  image            String?
  description      String?
  isService        Boolean           @default(false)
  isActive         Boolean           @default(true)
  createdAt        DateTime          @default(now())
  updatedAt        DateTime          @updatedAt
  category         Category?         @relation(fields: [categoryId], references: [id])
  priceHistory     PriceHistory[]
  stockMovements   StockMovement[]
  transactionItems TransactionItem[]
  treatments       Treatment[]

  @@map("products")
}

model StockMovement {
  id         String       @id @default(cuid())
  productId  String
  type       MovementType
  quantity   Decimal      @db.Decimal(12, 3)
  unitPrice  Decimal      @db.Decimal(12, 2)
  totalPrice Decimal      @db.Decimal(12, 2)
  reference  String?
  notes      String?
  createdAt  DateTime     @default(now())
  product    Product      @relation(fields: [productId], references: [id])

  @@map("stock_movements")
}

model Transaction {
  id            String            @id @default(cuid())
  code          String            @unique
  type          TransactionType
  customerId    String?
  supplierId    String?
  animalId      String?
  userId        String
  date          DateTime          @default(now())
  dueDate       DateTime?
  subtotal      Decimal           @db.Decimal(12, 2)
  vatTotal      Decimal           @default(0) @db.Decimal(12, 2)
  discount      Decimal           @default(0) @db.Decimal(12, 2)
  total         Decimal           @db.Decimal(12, 2)
  paidAmount    Decimal           @default(0) @db.Decimal(12, 2)
  paymentMethod PaymentMethod?
  status        TransactionStatus @default(PENDING)
  notes         String?
  createdAt     DateTime          @default(now())
  updatedAt     DateTime          @updatedAt
  payments      Payment[]
  items         TransactionItem[]
  allocations   CollectionAllocation[]
  animal        Animal?           @relation(fields: [animalId], references: [id])
  customer      Customer?         @relation(fields: [customerId], references: [id])
  supplier      Supplier?         @relation(fields: [supplierId], references: [id])
  user          User              @relation(fields: [userId], references: [id])

  @@map("transactions")
}

model TransactionItem {
  id            String      @id @default(cuid())
  transactionId String
  productId     String
  quantity      Decimal     @db.Decimal(12, 3)
  unitPrice     Decimal     @db.Decimal(12, 2)
  vatRate       Decimal     @default(0) @db.Decimal(5, 2)
  discount      Decimal     @default(0) @db.Decimal(12, 2)
  total         Decimal     @db.Decimal(12, 2)
  product       Product     @relation(fields: [productId], references: [id])
  transaction   Transaction @relation(fields: [transactionId], references: [id], onDelete: Cascade)

  @@map("transaction_items")
}

model Payment {
  id            String        @id @default(cuid())
  transactionId String
  amount        Decimal       @db.Decimal(12, 2)
  method        PaymentMethod
  checkNumber   String?
  checkDate     DateTime?
  bankName      String?
  notes         String?
  createdAt     DateTime      @default(now())
  transaction   Transaction   @relation(fields: [transactionId], references: [id], onDelete: Cascade)

  @@map("payments")
}

model Animal {
  id           String           @id @default(cuid())
  customerId   String
  name         String
  species      Species
  breed        String?
  gender       Gender?
  birthDate    DateTime?
  weight       Decimal?         @db.Decimal(8, 2)
  color        String?
  chipNumber   String?
  earTag       String?
  image        String?
  notes        String?
  isActive     Boolean          @default(true)
  createdAt    DateTime         @default(now())
  updatedAt    DateTime         @updatedAt
  protocols    AnimalProtocol[]
  customer     Customer         @relation(fields: [customerId], references: [id])
  reminders    Reminder[]
  transactions Transaction[]
  illnesses    Illness[]

  @@map("animals")
}

model Protocol {
  id              String           @id @default(cuid())
  name            String
  type            ProtocolType
  species         Species[]
  description     String?
  isDefault       Boolean          @default(false)
  isActive        Boolean          @default(true)
  createdAt       DateTime         @default(now())
  updatedAt       DateTime         @updatedAt
  animalProtocols AnimalProtocol[]
  steps           ProtocolStep[]

  @@map("protocols")
}

model ProtocolStep {
  id         String   @id @default(cuid())
  protocolId String
  name       String
  dayOffset  Int
  notes      String?
  order      Int      @default(0)
  protocol   Protocol @relation(fields: [protocolId], references: [id], onDelete: Cascade)

  @@map("protocol_steps")
}

model AnimalProtocol {
  id         String           @id @default(cuid())
  animalId   String
  protocolId String
  startDate  DateTime
  status     ProtocolStatus   @default(ACTIVE)
  notes      String?
  createdAt  DateTime         @default(now())
  updatedAt  DateTime         @updatedAt
  animal     Animal           @relation(fields: [animalId], references: [id])
  protocol   Protocol         @relation(fields: [protocolId], references: [id])
  records    ProtocolRecord[]

  @@map("animal_protocols")
}

model ProtocolRecord {
  id               String         @id @default(cuid())
  animalProtocolId String
  stepName         String
  scheduledDate    DateTime
  completedDate    DateTime?
  status           RecordStatus   @default(PENDING)
  notes            String?
  createdAt        DateTime       @default(now())
  animalProtocol   AnimalProtocol @relation(fields: [animalProtocolId], references: [id], onDelete: Cascade)

  @@map("protocol_records")
}

model Reminder {
  id          String       @id @default(cuid())
  userId      String
  type        ReminderType
  title       String
  description String?
  dueDate     DateTime
  customerId  String?
  supplierId  String?
  animalId    String?
  isRead      Boolean      @default(false)
  isCompleted Boolean      @default(false)
  createdAt   DateTime     @default(now())
  animal      Animal?      @relation(fields: [animalId], references: [id])
  customer    Customer?    @relation(fields: [customerId], references: [id])
  supplier    Supplier?    @relation(fields: [supplierId], references: [id])
  user        User         @relation(fields: [userId], references: [id])

  @@map("reminders")
}

model Setting {
  id        String   @id @default(cuid())
  key       String   @unique
  value     String
  type      String   @default("string")
  updatedAt DateTime @updatedAt

  @@map("settings")
}

enum UserRole {
  ADMIN
  MANAGER
  VETERINARIAN
  ACCOUNTANT
  USER
}

enum MovementType {
  PURCHASE
  SALE
  ADJUSTMENT
  RETURN
  WASTE
}

enum TransactionType {
  PURCHASE
  SALE
  TREATMENT
  CUSTOMER_PAYMENT
  SUPPLIER_PAYMENT
  REFUND
}

enum TransactionStatus {
  PENDING
  PARTIAL
  PAID
  CANCELLED
}

enum PaymentMethod {
  CASH
  CREDIT_CARD
  BANK_TRANSFER
  CHECK
  PROMISSORY
}

enum Species {
  DOG
  CAT
  CATTLE
  SHEEP
  GOAT
  HORSE
  BIRD
  RABBIT
  FISH
  REPTILE
  RODENT
  OTHER
}

enum Gender {
  MALE
  FEMALE
}

enum ProtocolType {
  VACCINATION
  FERTILITY
  TREATMENT
  CHECKUP
}

enum ProtocolStatus {
  ACTIVE
  COMPLETED
  CANCELLED
}

enum RecordStatus {
  PENDING
  COMPLETED
  MISSED
  CANCELLED
}

enum ReminderType {
  PAYMENT_DUE
  COLLECTION_DUE
  VACCINATION
  FERTILITY
  CHECK_MATURITY
  STOCK_CRITICAL
  CUSTOM
}

enum ProductCategory {
  MEDICINE          // İlaç
  SERVICE           // Hizmet (stok takibi yok)
  MEDICAL_SUPPLY    // Medikal Malzeme
  PREMIX            // Premix
  FEED              // Yem
}

enum IllnessStatus {
  ACTIVE      // Aktif tedavi görüyor
  RECOVERED   // İyileşti
  CHRONIC     // Kronik hastalık
  MONITORING  // İzleme altında
  CANCELLED   // İptal edildi
}

enum IllnessSeverity {
  MILD        // Hafif
  MODERATE    // Orta
  SEVERE      // Şiddetli
  CRITICAL    // Kritik
}

enum TreatmentStatus {
  PLANNED     // Planlandı
  ONGOING     // Devam ediyor
  COMPLETED   // Tamamlandı
  PAUSED      // Durduruldu
  CANCELLED   // İptal edildi
}

model PriceHistory {
  id            String   @id @default(cuid())
  productId     String
  product       Product  @relation(fields: [productId], references: [id], onDelete: Cascade)
  oldPrice      Decimal  @db.Decimal(12, 2)
  newPrice      Decimal  @db.Decimal(12, 2)
  changeReason  String?
  changedBy     String?
  createdAt     DateTime @default(now())
  
  @@map("price_history")
  @@index([productId])
  @@index([createdAt])
}

model Illness {
  id            String          @id @default(cuid())
  animalId      String
  name          String
  diagnosis     String?
  symptoms      String?
  findings      String?
  notes         String?
  startDate     DateTime        @default(now())
  endDate       DateTime?
  status        IllnessStatus   @default(ACTIVE)
  severity      IllnessSeverity @default(MODERATE)
  attachments   String[]        @default([])
  createdAt     DateTime        @default(now())
  updatedAt     DateTime        @updatedAt
  animal        Animal          @relation(fields: [animalId], references: [id], onDelete: Cascade)
  treatments    Treatment[]

  @@map("illnesses")
  @@index([animalId])
  @@index([status])
  @@index([startDate])
}

model Treatment {
  id              String          @id @default(cuid())
  illnessId       String
  productId       String?
  name            String
  dosage          String?
  frequency       String?
  duration        String?
  startDate       DateTime        @default(now())
  endDate         DateTime?
  applicationMethod String?
  notes           String?
  cost            Decimal         @default(0) @db.Decimal(12, 2)
  status          TreatmentStatus @default(ONGOING)
  nextCheckupDate DateTime?
  createdAt       DateTime        @default(now())
  updatedAt       DateTime        @updatedAt
  illness         Illness         @relation(fields: [illnessId], references: [id], onDelete: Cascade)
  product         Product?        @relation(fields: [productId], references: [id])

  @@map("treatments")
  @@index([illnessId])
  @@index([productId])
  @@index([status])
  @@index([startDate])
}

// =====================================================
// TAHSİLAT SİSTEMİ (COLLECTION SYSTEM)
// =====================================================

model Collection {
  id              String                 @id @default(cuid())
  code            String                 @unique
  customerId      String
  userId          String
  amount          Decimal                @db.Decimal(12, 2)
  paymentMethod   PaymentMethod
  collectionDate  DateTime               @default(now())
  notes           String?
  
  // Çek bilgileri (opsiyonel)
  checkNumber     String?
  checkDate       DateTime?
  bankName        String?
  
  // Banka transfer bilgileri (opsiyonel)
  referenceNumber String?
  
  createdAt       DateTime               @default(now())
  updatedAt       DateTime               @updatedAt
  
  customer        Customer               @relation(fields: [customerId], references: [id])
  user            User                   @relation(fields: [userId], references: [id])
  allocations     CollectionAllocation[]
  
  @@map("collections")
  @@index([customerId])
  @@index([collectionDate])
  @@index([code])
}

model CollectionAllocation {
  id            String      @id @default(cuid())
  collectionId  String
  transactionId String
  amount        Decimal     @db.Decimal(12, 2)
  createdAt     DateTime    @default(now())
  
  collection    Collection  @relation(fields: [collectionId], references: [id], onDelete: Cascade)
  transaction   Transaction @relation(fields: [transactionId], references: [id])
  
  @@map("collection_allocations")
  @@index([collectionId])
  @@index([transactionId])
}
